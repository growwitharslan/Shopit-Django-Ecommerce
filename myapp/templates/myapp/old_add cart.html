
<script>
    $(function () {
        // --- Prevent duplicate bindings ---
        $(document).off("click", ".add");
        $(document).off("click", ".sub");
        $(document).off("click", ".remove-btn");
        // --- Initialize toastr ---
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-bottom-right",
            "timeOut": "3000"
        };

        // Increase quantity
        $(document).on("click", ".add", function () {
            let row = $(this).closest("tr");
            let pid = row.find(".remove-btn").data("id");
            let qtyInput = row.find("input[type='number']");
            let current = parseInt(qtyInput.val()) || 0;
            let max = parseInt(qtyInput.attr("max")) || 9999;
            

            if (current < max) {
                let quantity = current + 1;
                updateCart(pid, quantity, row);
            } else {
                toastr.warning("Stock limit reached!");
                
            }
        });



        // Decrease quantity
        $(document).on("click", ".sub", function () {
            let row = $(this).closest("tr");
            let pid = row.find(".remove-btn").data("id");
            let qtyInput = row.find("input[type='number']");
            let quantity = Math.max(parseInt(qtyInput.val()) - 1, 1); // prevent 0
            updateCart(pid, quantity, row);
        });


        // Remove item from cart
        $(document).on("click", ".remove-btn", function (e) {
            e.preventDefault();
            let productId = $(this).data('id');
            let row = $('#cart-item-' + productId);

            if (confirm('Are you sure you want to remove this item?')) {
                $.ajax({
                    url: "{% url 'remove_from_cart_ajax' %}",
                    type: "POST",
                    data: {
                        product_id: productId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.status === 'success') {
                            // remove item row
                            row.remove();

                            // update totals & count
                            $(".total-payable .price").text(`$${response.overall_subtotal}`);
                            $("#cart-count").text(response.cart_count);

                            // show success toast
                            toastr.success("Item removed from cart!");

                            // handle empty cart
                            if ($('tbody tr').length === 0) {
                                $(".checkout-style-1").html(`
                            <div class="text-center p-4">
                                <img src="{% static 'images/empty_cart.png' %}" 
                                     alt="Empty Cart" 
                                     class="img-fluid mb-3" 
                                     style="max-width: 200px;">
                                <h2 class="text-muted">Your cart is empty</h2>
                                <p class="text-secondary mb-3">Looks like you haven’t added anything yet.</p>
                                <a href="{% url 'shop_products' %}" class="main-btn primary-btn">Start Shopping</a>
                            </div>
                        `);
                            }
                        } else {
                            toastr.error("Failed to remove item.");
                        }
                    },
                    error: function () {
                        toastr.error("Something went wrong. Try again!");
                    }
                });
            }
        });


        // --- AJAX update cart function ---
        function updateCart(productId, quantity, row) {
            $.ajax({
                url: "{% url 'add_to_cart' %}",
                type: "POST",
                data: {
                    product_id: productId,
                    quantity: quantity,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (response) {
                    if (response.status === "success") {
                        // ✅ always overwrite with backend’s value
                        row.find("input[type='text']").val(response.quantity);
                        row.find("td:nth-child(4) .price").text(`$${response.product_subtotal}`);
                        $(".total-payable .price").text(`$${response.overall_subtotal}`);
                    }
                }
            });
        }


        // --- Stripe Checkout ---
        var stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
        $('#checkout-button').click(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/create-checkout-session/',
                type: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function (data) {
                    stripe.redirectToCheckout({ sessionId: data.id });
                },
                error: function () {
                    alert("Checkout failed.");
                }
            });
        });
    });
</script>



