{% extends "myapp/base.html" %}
{% load static %}
{% load cart_extras %}

{% block title %}Cart{% endblock %}

{% block content %}
<!--====== Checkout 2 Part Start ======-->
<section class="checkout-wrapper pt-50">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="checkout-style-1">
                    {% if cart %}
                    <div class="checkout-table table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="product">Product</th>
                                    <th class="price">Price</th>
                                    <th class="quantity">Quantity</th>
                                    <th class="price">Subotal</th>
                                    <th class="action">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pid, item in cart.items %}
                                <tr id="cart-item-{{ pid }}">
                                    <td>
                                        <div class="product-cart d-flex">
                                            <div class="product-thumb" style="width: 50px;">
                                                <img src="{{ item.image }}" alt="Product" />
                                            </div>
                                            <div class="product-content media-body">
                                                <h5 class="title">
                                                    <a href="{% url 'product_detail' pid %}">{{ item.name }}</a>
                                                </h5>
                                                <span>SHOPit Exclusive</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="price">${{ item.price }}</p>
                                    </td>
                                    <td>
                                        <div class="product-quantity d-inline-flex">
                                            <button type="button" id="sub" class="sub">
                                                <i class="mdi mdi-minus"></i>
                                            </button>
                                            <input type="number" value="{{ item.quantity }}" max="{{ item.stock }}"
                                                readonly />
                                            <button type="button" id="add" class="add">
                                                <i class="mdi mdi-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="price">${{ item.subtotal }}</p>
                                    </td>
                                    <td>
                                        <ul class="action">
                                            <li>
                                                <a class="delete remove-btn" href="#" data-id="{{ pid }}"><i
                                                        class="mdi mdi-delete"></i></a>
                                            </li>
                                        </ul>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Totals -->
                    <div class="checkout-coupon-total checkout-coupon-total-2 d-flex justify-content-end mb-2">
                        <div class="checkout-total text-end">
                            <div class="single-total total-payable bg-light p-3 rounded-3 shadow-sm">
                                <p class="value mb-1 fw-semibold">Total Payable:</p>
                                <p class="price h5 fw-bold text-dark">${{ overall_subtotal }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-btn d-sm-flex justify-content-between">
                        <div class="single-btn">
                            <a href="{% url 'shop_products' %}" class="main-btn primary-btn-border">continue
                                shopping</a>
                        </div>
                        {% if request.user.is_authenticated %}
                        <div class="single-btn">
                            <button type="button" id="checkout-button" class="main-btn primary-btn"
                                style="display: inline-flex; align-items: center; gap: 6px;">
                                Pay With Stripe
                            </button>

                        </div>
                        {% else %}
                        <div class="single-btn">
                            <a href="{% url 'login' %}" class="main-btn primary-btn"
                                style="display: inline-flex; align-items: center; gap: 6px;">
                                Login to Continue
                            </a>

                        </div>
                        {% endif %}

                    </div>
                    {% else %}
                    <div class="text-center p-4">
                        <img src="{% static 'images/empty_cart.png' %}" alt="Empty Cart" class="img-fluid mb-3"
                            style="max-width: 200px;">
                        <h2 class="text-muted">Your cart is empty</h2>
                        <p class="text-secondary mb-3">Looks like you have not added anything yet.</p>
                        <a href="{% url 'shop_products' %}" class="main-btn primary-btn">Start Shopping</a>
                    </div>

                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</section>
<!--====== Checkout 2 Part Ends ======-->
{% endblock %}

{% block scripts %}
<script>
    $(function () {
        // --- Prevent duplicate bindings ---
        $(document).off("click", ".add");
        $(document).off("click", ".sub");
        $(document).off("click", ".remove-btn");
        // --- Initialize toastr ---
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-bottom-right",
            "timeOut": "3000"
        };

        // Increase quantity
        $(document).on("click", ".add", function () {
            let row = $(this).closest("tr");
            let pid = row.find(".remove-btn").data("id");
            let qtyInput = row.find("input[type='number']");
            let current = parseInt(qtyInput.val()) || 0;
            let max = parseInt(qtyInput.attr("max")) || 9999;
            

            if (current < max) {
                let quantity = current + 1;
                updateCart(pid, quantity, row);
            } else {
                toastr.warning("Stock limit reached!");
                
            }
        });



        // Decrease quantity
        $(document).on("click", ".sub", function () {
            let row = $(this).closest("tr");
            let pid = row.find(".remove-btn").data("id");
            let qtyInput = row.find("input[type='number']");
            let quantity = Math.max(parseInt(qtyInput.val()) - 1, 1); // prevent 0
            updateCart(pid, quantity, row);
        });


        // Remove item from cart
        $(document).on("click", ".remove-btn", function (e) {
            e.preventDefault();
            let productId = $(this).data('id');
            let row = $('#cart-item-' + productId);

            if (confirm('Are you sure you want to remove this item?')) {
                $.ajax({
                    url: "{% url 'remove_from_cart_ajax' %}",
                    type: "POST",
                    data: {
                        product_id: productId,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (response) {
                        if (response.status === 'success') {
                            // remove item row
                            row.remove();

                            // update totals & count
                            $(".total-payable .price").text(`$${response.overall_subtotal}`);
                            $("#cart-count").text(response.cart_count);

                            // show success toast
                            toastr.success("Item removed from cart!");

                            // handle empty cartt
                            if ($('tbody tr').length === 0) {
                                $(".checkout-style-1").html(`
                            <div class="text-center p-4">
                                <img src="{% static 'images/empty_cart.png' %}" 
                                     alt="Empty Cart" 
                                     class="img-fluid mb-3" 
                                     style="max-width: 200px;">
                                <h2 class="text-muted">Your cart is empty</h2>
                                <p class="text-secondary mb-3">Looks like you haven’t added anything yet.</p>
                                <a href="{% url 'shop_products' %}" class="main-btn primary-btn">Start Shopping</a>
                            </div>
                        `);
                            }
                        } else {
                            toastr.error("Failed to remove item.");
                        }
                    },
                    error: function () {
                        toastr.error("Something went wrong. Try again!");
                    }
                });
            }
        });


        // --- AJAX update cart function ---
        function updateCart(productId, quantity, row) {
            $.ajax({
                url: "{% url 'add_to_cart' %}",
                type: "POST",
                data: {
                    product_id: productId,
                    quantity: quantity,
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (response) {
                    if (response.status === "success") {
                        // ✅ always overwrite with backend’s value
                        row.find("input[type='text']").val(response.quantity);
                        row.find("td:nth-child(4) .price").text(`$${response.product_subtotal}`);
                        $(".total-payable .price").text(`$${response.overall_subtotal}`);
                    }
                }
            });
        }


        // --- Stripe Checkout ---
        var stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
        $('#checkout-button').click(function (e) {
            e.preventDefault();
            $.ajax({
                url: '/create-checkout-session/',
                type: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function (data) {
                    stripe.redirectToCheckout({ sessionId: data.id });
                },
                error: function () {
                    alert("Checkout failed.");
                }
            });
        });
    });
</script>


{% endblock %}